% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/link_daily.R
\name{link_daily}
\alias{link_daily}
\alias{link_daily.sf}
\alias{link_daily.SpatRaster}
\alias{link_daily.stars}
\alias{link_daily.SpatVector}
\alias{link_daily.Spatial}
\title{Link with ERA5 daily indicators}
\usage{
link_daily(
  .data,
  indicator,
  ...,
  cache = TRUE,
  path = NULL,
  parallel = FALSE,
  chunk_size = 50,
  verbose = TRUE
)

\method{link_daily}{sf}(
  .data,
  indicator,
  date_var = "date",
  time_span = 0,
  time_lag = 0,
  buffer = 0,
  baseline = FALSE,
  catalogue = "derived-era5-land-daily-statistics",
  statistic = "daily_mean",
  time_zone = "utc+00:00",
  cache = TRUE,
  path = NULL,
  parallel = FALSE,
  chunk_size = 50,
  verbose = TRUE
)

\method{link_daily}{SpatRaster}(
  .data,
  indicator,
  time_span = 0,
  time_lag = 0,
  baseline = FALSE,
  method = "bilinear",
  catalogue = "derived-era5-land-daily-statistics",
  statistic = "daily_mean",
  time_zone = "utc+00:00",
  cache = TRUE,
  path = NULL,
  parallel = FALSE,
  chunk_size = 5000,
  verbose = TRUE
)

\method{link_daily}{stars}(.data, indicator, ...)

\method{link_daily}{SpatVector}(.data, indicator, ...)

\method{link_daily}{Spatial}(.data, indicator, ...)
}
\arguments{
\item{.data}{An \code{sf} object containing the spatial data (polygons or points).}

\item{indicator}{Character string specifying the indicator to download
(e.g., \code{"2m_temperature"}). Allowed indicators differ by catalogue. See
the \strong{Details} section for available indicators.}

\item{...}{Arguments passed to methods. If \code{.data} is a stars object,
arguments are passed to \code{link_daily.SpatRaster}, otherwise to
\code{link_daily.sf}.}

\item{cache}{Logical value indicating whether to keep the downloaded
files and restore them when downloading the same file again.
Enabling caching can speed up functions calls significantly when working
with the same files repeatedly. See the \strong{Caching} section for details. If
\code{FALSE}, removes the raw files after processing.}

\item{path}{Character string specifying the directory path where data will
be downloaded and cached. If \code{NULL}, the directory depends on whether
caching is enabled. If \code{cache = FALSE}, files are stored in a temporary
directory (\code{\link{tempdir}}), otherwise they are stored in the user
directory (\code{\link{R_user_dir}}). Defaults to \code{NULL}.}

\item{parallel}{Logical indicating whether to use parallel processing with
chunking. See section \strong{Parallel processing} for details. Default is
\code{FALSE} (i.e., sequential execution).}

\item{chunk_size}{Integer specifying the number of observations per chunk
when parallelizing. This is the number of rows that is processed
simultaneously during parallel processing. Setting this to something lower
than \code{nrow(.data)} increases the total number of parallel processes.
Default is \code{50}.}

\item{verbose}{Logical value specifiying whether to show informative status
updates. If \code{FALSE}, suppresses all messages signaled by the function.
Defaults to \code{TRUE}.}

\item{date_var}{Character string specifying the name of the date variable in \code{data}.}

\item{time_span}{Integer specifying the time span in days for averaging the
climate indicator values prior to linking with the spatial data (default
is \code{0}).}

\item{time_lag}{Integer specifying the time lag in days to shift the
\code{date_var} backward (default is \code{0}).}

\item{buffer}{Numeric value specifying the buffer radius (in kilometers) to
be applied around each geometry. The default is \code{0}, corresponding to a
direct cell match; values greater than 0 generate a spatial buffer
around each point for aggregated extraction.}

\item{baseline}{Either \code{FALSE} (default) or a character vector of length 2
specifying the baseline period in years. For example,
\code{baseline = c("1980", "2010")} uses the years 1980 to 2010 as the baseline.
If \code{FALSE}, no baseline calculation is performed.}

\item{catalogue}{Character string specifying which ERA5 catalogue to use.
Options are \code{"derived-era5-land-daily-statistics"} (default) or
\code{"derived-era5-single-levels-daily-statistics"}. The first is a good
default for land surface processes while the latter includes data from
both land and oceans.}

\item{statistic}{Character string specifying the type of daily statistic to
download. Options are \code{"daily_mean"} (default), \code{"daily_maximum"}, and
\code{"daily_minimum"}.}

\item{time_zone}{Character string specifying the time zone to use (default
is \code{"utc+00:00"}).}

\item{method}{Character string specifying the resampling method to use when
aligning the downloaded data with the grid. Options include \code{"bilinear"}
(default), \code{"near"}, \code{"cubic"}, etc. See \code{\link[terra]{resample}} for
details.}
}
\value{
An object of the input class (i.e. if \code{.data} is an sf dataframe,
the function returns an sf dataframe) with the original data and appended
climate indicator values. If a baseline period is specified, additional
data for baseline values and deviations are included. The output contains
the following columns / layers:

\itemize{
\item{\code{.linked}: Linked climate indicator value}
\item{\code{.baseline}: Linked baseline indicator value (if applicable)}
\item{\code{.deviation}: Difference between \code{.linked} and \code{.baseline} (if applicable)}
}
}
\description{
Augments spatio-temporal data with daily indicators from the
Copernicus earth observation database (ERA5).
The function performs the following pre-/post-processing steps:

\itemize{
\item{Construct time adjustments (time aggregations, time lags)}
\item{Compute space adjustments (spatial buffers)}
\item{Download daily statistics from Copernicus database}
\item{Link raster statistics back to input}
\item{Optionally, add comparative statistics based on a baseline period}
}

This function interfaces the daily means of ERA5 indicators. For monthly
means see \code{\link{link_monthly}}.
}
\details{
This function interacts with the Copernicus Climate Data Store (CDS) API to
download ERA5 daily reanalysis data for a specified climate indicator and
time period based on daily temporal resolution. The input spatial points
(an sf object) are first optionally buffered (if \code{buffer > 0}), then
processed to determine the geographic extent. The time dimension is adjusted
using the specified \code{time_lag} and \code{time_span} (both in days) to create
daily time sequences based on the given \code{date_var}. The function downloads
the corresponding daily statistics (e.g., daily mean, maximum, or minimum)
and extracts these values for each point. When no buffer is specified, the
value from the directly underlying raster cell is extracted; if a buffer is
specified, the mean value over the buffer area is computed. If a baseline
period is provided (e.g., \code{baseline = c("1980", "2010")}), baseline daily
statistics are downloaded for the specified period and appended as a new
attribute.

The following indicators are currently supported:

\tabular{ll}{
\strong{Land} \tab \strong{Single Levels}\cr
\code{2m_temperature} \tab \code{2m_temperature}
}
}
\note{
Users must have a CDS account and have their API key configured for
\code{ecmwfr}.
}
\section{Parallel processing}{

This function can use parallel processing with chunking via
\code{\link[future.apply]{future_lapply}} when \code{parallel = TRUE}. If
\code{parallel = FALSE}, the function runs sequentially. When \code{parallel = TRUE},
set your parallel plan (for example, using
\code{\link[future]{plan}(multisession, workers = 6)})
before calling this function. If no plan is set before but \code{parallel = TRUE},
the function will run sequentially through the chunks, which will most
likely increase duration.
}

\examples{
\dontrun{
library(sf)

# Create sample point data (sf object)
pts <- data.frame(
  lon = c(13.4, 11.6, 9.9),
  lat = c(52.5, 51.3, 50.1),
  date = c("2014-08-01", "2014-08-01", "2014-08-01")
)
pts_sf <- st_as_sf(pts, coords = c("lon", "lat"), crs = 4326)

# Example: Direct extraction (buffer = 0)
result1 <- link_daily(pts_sf, indicator = "2m_temperature")

# Example: Aggregated extraction with a 5 km buffer
result2 <- link_daily(
  pts_sf,
  indicator = "2m_temperature",
  buffer = 5,
  baseline = c("1980", "2010")
)

# View the results
head(result1)
head(result2)

# The input can also be raster
germany_bbox <- c(xmin = 5, xmax = 16, ymin = 47, ymax = 55) # approximate extent
grid <- rast(
  xmin = germany_bbox["xmin"], xmax = germany_bbox["xmax"],
  ymin = germany_bbox["ymin"], ymax = germany_bbox["ymax"]
)
terra::time(grid) <- as.Date("2014-08-01")

link_daily(grid, indicator = "2m_temperature")}
}
