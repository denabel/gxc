% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/point_link_monthly.R
\name{point_link_monthly}
\alias{point_link_monthly}
\title{Link Spatial Points with Copernicus Earth Observation Monthly Indicators}
\usage{
point_link_monthly(
  indicator,
  data,
  date_var,
  time_span = 0,
  time_lag = 0,
  buffer = 0,
  baseline = FALSE,
  order = "my",
  path = "./data/raw",
  catalogue = "reanalysis-era5-land-monthly-means",
  by_hour = FALSE,
  keep_raw = FALSE,
  parallel = FALSE,
  chunk_size = 50
)
}
\arguments{
\item{indicator}{Character string specifying the indicator to download (e.g., "2m_temperature").
Allowed indicators differ by catalogue. See the \strong{Details} section for available indicators.}

\item{data}{An \code{sf} object containing the spatial data (polygons or points).}

\item{date_var}{Character string specifying the name of the date variable in \code{data}.}

\item{time_span}{Integer specifying the time span in months for averaging the climate indicator
values prior to linking with the spatial data (default is \code{0}).}

\item{time_lag}{Integer specifying the time lag in months to shift the \code{date_var} backward
(default is \code{0}).}

\item{buffer}{Numeric value (in kilometers) specifying the buffer radius to be applied around each point.
The default is \code{0}, corresponding to a direct cell match; values greater than \code{0} generate a buffer for aggregated extraction.}

\item{baseline}{Either \code{FALSE} (default) or a character vector of length 2 specifying the baseline
period in years. For example, \code{baseline = c("1980", "2010")} uses the years 1980 to 2010 as the baseline.
If \code{FALSE}, no baseline calculation is performed.}

\item{order}{Character string specifying the date format for parsing \code{date_var}
(default is \code{"my"} for month-year format).}

\item{path}{Character string specifying the directory path where data will be downloaded and/or stored
(default is \code{"./data/raw"}).}

\item{catalogue}{Character string specifying which ERA5 catalogue to use.
Options are \code{"reanalysis-era5-land-monthly-means"} (default, higher resolution but lower temporal
coverage)
or \code{"reanalysis-era5-single-levels-monthly-means"} (lower resolution but larger temporal coverage).}

\item{by_hour}{Logical or character. If \code{FALSE} (default), the monthly averaged values are derived
from the entire day (\code{"monthly_averaged_reanalysis"}). If a character string specifying an hour (e.g., \code{"03:00"}),
then the dataset \code{"monthly_averaged_reanalysis_by_hour_of_day"} is used, and only values from that hour of the day
are included.}

\item{keep_raw}{Logical value indicating whether to keep the downloaded raw \code{.grib} files.
If \code{FALSE}, the files are deleted after processing (default is \code{FALSE}).}

\item{parallel}{Logical indicating whether to use parallel processing with chunking.
Default is \code{FALSE} (i.e. sequential execution).}

\item{chunk_size}{Integer specifying the number of observations per chunk when parallelizing.
Default is \code{50}.}
}
\value{
An sf object with the original spatial points (possibly buffered)
and appended climate indicator values. If a baseline period is specified,
additional columns for baseline values (and optionally deviations) are
included.
}
\description{
Downloads and processes Copernicus Earth observation data (ERA5) based on monthly temporal parameters,
and extracts the corresponding climate indicator values for the provided spatial points. The function uses the
time dimension of the input points (an sf object) along with specified time adjustments (time_lag and time_span, in months)
to build monthly time sequences (with dates assumed to be on the first day of each month). In addition, an optional
spatial buffer (in kilometers) can be applied around each point; when \code{buffer > 0}, the value is aggregated (using the mean)
over the buffered area instead of using the direct underlying cell value. The function then downloads the corresponding
monthly reanalysis data (using either the standard dataset or the by‑hour variant, as specified) and extracts these values for
each point. If a baseline period is provided (e.g., \code{baseline = c("1980", "2010")}), baseline monthly statistics are downloaded
for the specified period and appended as an additional attribute. Optionally, deviations between the focal and baseline values
can be computed.
}
\details{
This function interacts with the Copernicus Climate Data Store (CDS) API to download ERA5 monthly reanalysis data for a specified
climate indicator and time period. The input spatial points (an sf object) are first optionally buffered (using the \code{buffer} argument)
to expand the extraction area. The function then determines the geographic extent from the (possibly buffered) points and adjusts the time
dimension based on the specified \code{date_var}, \code{time_lag}, and \code{time_span} (all in months). Monthly time sequences are constructed assuming
that dates correspond to the first day of each month. The function downloads the corresponding monthly data (or hourly-based monthly averages if
\code{by_hour} is specified) and extracts these values for each point—using a direct cell match when \code{buffer = 0} or aggregating over the buffer area
when \code{buffer > 0}. If a baseline period is provided (e.g., \code{baseline = c("1980", "2010")}), baseline monthly statistics are downloaded for the
specified period and appended as an additional attribute. Optionally, deviations between the focal and baseline values may be computed.

\strong{Note:} Users must have a CDS account and have their API key configured for \code{ecmwfr}.

The function now supports an extended set of indicators. The allowed indicators depend on the chosen \code{catalogue}:

\strong{For \code{"reanalysis-era5-land-monthly-means"}} (higher resolution, from 1950 onwards):
\itemize{
\item \code{"2m_temperature"}
\item \code{"total_precipitation"}
\item \code{"10m_u_component_of_wind"}
\item \code{"10m_v_component_of_wind"}
\item \code{"leaf_area_index_high_vegetation"}
\item \code{"leaf_area_index_low_vegetation"}
\item \code{"snowfall"}
}

\strong{For \code{"reanalysis-era5-single-levels-monthly-means"}} (lower resolution, from 1940 onwards):
\itemize{
\item \code{"2m_temperature"}
\item \code{"10m_u_component_of_wind"}
\item \code{"10m_v_component_of_wind"}
\item \code{"10m_wind_speed"}
\item \code{"total_cloud_cover"}
\item \code{"leaf_area_index_high_vegetation"}
\item \code{"leaf_area_index_low_vegetation"}
}

If \code{keep_raw = TRUE}, the original \code{.grib} files downloaded from the CDS are retained in the specified \code{path}.
If \code{keep_raw = FALSE}, these files are removed after processing, saving storage space.

The default catalogue \code{"reanalysis-era5-land-monthly-means"} provides higher spatial resolution at 0.1x0.1 degrees
but is only available from 1950 onwards. If you need data before 1950 or if you are working with large
spatial extents where finer resolution is not required, you can switch to
\code{"reanalysis-era5-single-levels-monthly-means"}. This dataset provides a spatial resolution of 0.25x0.25 degrees and
a temporal coverage until 1940.

If \code{by_hour} is specified as an hour (e.g. \code{"03:00"}), monthly averages for that specific hour of the day are accessed.
This can be useful if you are interested in intra-day climate patterns over long periods such as heat or cold during
day or nighttime. The time is specified as UTC.

\strong{Parallel Processing:}
This function can use parallel processing with chunking via
\code{future.apply::future_lapply} when \code{parallel = TRUE}. If \code{parallel = FALSE},
the function runs sequentially. When \code{parallel = TRUE}, set your parallel
plan (for example, using \code{future::plan(multisession, workers = 6)})
before calling this function. If no plan is set before but \code{parallel = TRUE},
the function will run sequentially through the chunks, which will most
likely increase duration.
}
\examples{
\dontrun{
library(sf)
library(dplyr)

# Create sample point data
pts <- data.frame(lon = c(13.4, 11.6, 9.9),
                  lat = c(52.5, 51.3, 50.1),
                  date_column = c("2014-01-01", "2014-01-01", "2014-01-01"))
pts_sf <- st_as_sf(pts, coords = c("lon", "lat"), crs = 4326)

# Example 1: Direct extraction (buffer = 0)
result1 <- point_link_monthly(
  indicator = "2m_temperature",
  data = pts_sf,
  date_var = "date_column",
  time_span = 0,
  time_lag = 0,
  buffer = 0,
  baseline = FALSE,
  order = "my",
  path = "./data/raw",
  catalogue = "reanalysis-era5-land-monthly-means",
  by_hour = FALSE,
  keep_raw = FALSE
)

# Example 2: Aggregated extraction with a 5 km buffer and a baseline period
result2 <- point_link_monthly(
  indicator = "2m_temperature",
  data = pts_sf,
  date_var = "date_column",
  time_span = 0,
  time_lag = 0,
  buffer = 5,
  baseline = c("1980", "2010"),
  order = "my",
  path = "./data/raw",
  catalogue = "reanalysis-era5-land-monthly-means",
  by_hour = FALSE,
  keep_raw = TRUE
)

# View the results:
head(result1)
head(result2)
}

}
